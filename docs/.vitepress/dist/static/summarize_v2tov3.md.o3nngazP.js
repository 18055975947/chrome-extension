import{_ as s,c as a,o as i,a4 as n,by as e}from"./chunks/framework.DUbQYUwk.js";const b=JSON.parse('{"title":"一、Chrome 插件 V2 迁移至 V3 版本","description":"","frontmatter":{},"headers":[],"relativePath":"summarize/v2tov3.md","filePath":"summarize/v2tov3.md"}'),l={name:"summarize/v2tov3.md"},t=n(`<h1 id="一、chrome-插件-v2-迁移至-v3-版本" tabindex="-1">一、Chrome 插件 V2 迁移至 V3 版本 <a class="header-anchor" href="#一、chrome-插件-v2-迁移至-v3-版本" aria-label="Permalink to &quot;一、Chrome 插件 V2 迁移至 V3 版本&quot;">​</a></h1><h2 id="一、manifest-v3" tabindex="-1">一、<code>Manifest V3</code> <a class="header-anchor" href="#一、manifest-v3" aria-label="Permalink to &quot;一、\`Manifest V3\`&quot;">​</a></h2><h3 id="_1-什么是-manifest-v3" tabindex="-1">1. 什么是 <code>Manifest V3</code> <a class="header-anchor" href="#_1-什么是-manifest-v3" aria-label="Permalink to &quot;1. 什么是 \`Manifest V3\`&quot;">​</a></h3><p>Manifest V3 是最新版插件平台。对可用的 API 做出了一些更改，并添加了一些新功能。</p><h3 id="_2-manifest-v3-目标" tabindex="-1">2. <code>Manifest V3</code> 目标 <a class="header-anchor" href="#_2-manifest-v3-目标" aria-label="Permalink to &quot;2. \`Manifest V3\` 目标&quot;">​</a></h3><p>Manifest V3 旨在成为我们的平台愿景的第一步，加强插件的隐私保护、安全性和性能。随着平台的变化，也在努力让用户更好地了解和控制哪些插件的功能。</p><h2 id="二、manifest-v2-支持时间表" tabindex="-1">二、<code>Manifest V2</code> 支持时间表 <a class="header-anchor" href="#二、manifest-v2-支持时间表" aria-label="Permalink to &quot;二、\`Manifest V2\` 支持时间表&quot;">​</a></h2><p><code>Chrome</code> 浏览器官方已经给出确定的时间来弃用 <code>V2</code> 版本的插件了。</p><blockquote><p>最早从 <strong>2024 年 6 月</strong>的 <code>Chrome</code> 127 开始，我们将开始停用 Chrome 的不稳定版本（开发者版、<code>Canary</code> 版和 <code>Beta</code> 版）中的 <code>Manifest V2</code> 插件。受此变化影响的用户会在浏览器中看到 <code>Manifest V2</code> 插件自动停用，并且无法再从 <code>Chrome</code> 应用商店安装 <code>Manifest V2</code> 插件。此外，<code>Manifest V2</code> 插件在 <code>Chrome</code> 应用商店中将不再拥有“精选”徽章（如果目前已有该徽章）。</p></blockquote><blockquote><p>如果企业如果使用 <code>ExtensionManifestV2Availability</code> 政策确保其组织中的 <code>Manifest V2</code> 插件能持续正常运行，则其组织中还有一年的时间（即在 2025 年 6 月之前）迁移 <code>Manifest V2</code> 插件。在此之前，已启用此政策的浏览器不会受到弃用安排的影响。</p></blockquote><blockquote><p>如果插件发布商目前仍在发布 <code>Manifest V2</code> 插件，我们强烈建议您在 2024 年 6 月之前完成向 <code>Manifest V3</code> 的迁移。</p></blockquote><blockquote><p>官方时间线</p></blockquote><h3 id="_1、2022-年-6-月-chrome-应用商店-不再有新的专用插件" tabindex="-1">1、2022 年 6 月：<code>Chrome</code> 应用商店 - 不再有新的专用插件 <a class="header-anchor" href="#_1、2022-年-6-月-chrome-应用商店-不再有新的专用插件" aria-label="Permalink to &quot;1、2022 年 6 月：\`Chrome\` 应用商店 - 不再有新的专用插件&quot;">​</a></h3><p><code>Chrome</code> 应用商店不再接受公开范围设为“不公开”的新 <code>Manifest V2</code> 插件。</p><h3 id="_2、2024-年-6-月-在稳定发布前弃用-chrome-mv2" tabindex="-1">2、2024 年 6 月：在稳定发布前弃用 <code>Chrome MV2</code> <a class="header-anchor" href="#_2、2024-年-6-月-在稳定发布前弃用-chrome-mv2" aria-label="Permalink to &quot;2、2024 年 6 月：在稳定发布前弃用 \`Chrome MV2\`&quot;">​</a></h3><h3 id="_3、2024-年-6-月-1-x-个月-弃用-chrome-mv2-并稳定发布" tabindex="-1">3、2024 年 6 月 + 1-X 个月：弃用 <code>Chrome MV2</code> 并稳定发布 <a class="header-anchor" href="#_3、2024-年-6-月-1-x-个月-弃用-chrome-mv2-并稳定发布" aria-label="Permalink to &quot;3、2024 年 6 月 + 1-X 个月：弃用 \`Chrome MV2\` 并稳定发布&quot;">​</a></h3><h3 id="_4、2025-年-6-月-chrome-mv2-弃用-企业版" tabindex="-1">4、2025 年 6 月：<code>Chrome MV2</code> 弃用（企业版） <a class="header-anchor" href="#_4、2025-年-6-月-chrome-mv2-弃用-企业版" aria-label="Permalink to &quot;4、2025 年 6 月：\`Chrome MV2\` 弃用（企业版）&quot;">​</a></h3><h1 id="二、manifest-v3-迁移核对列表" tabindex="-1">二、<code>Manifest V3</code> 迁移核对列表 <a class="header-anchor" href="#二、manifest-v3-迁移核对列表" aria-label="Permalink to &quot;二、\`Manifest V3\` 迁移核对列表&quot;">​</a></h1><h2 id="_1、manifest-json-文件" tabindex="-1">1、<code>Manifest.json</code> 文件 <a class="header-anchor" href="#_1、manifest-json-文件" aria-label="Permalink to &quot;1、\`Manifest.json\` 文件&quot;">​</a></h2><h3 id="_1-更新-manifest-version-版本号" tabindex="-1">1. 更新 <code>manifest_version</code> 版本号 <a class="header-anchor" href="#_1-更新-manifest-version-版本号" aria-label="Permalink to &quot;1. 更新 \`manifest_version\` 版本号&quot;">​</a></h3><p>将 <code>manifest_version</code> 字段的值从 2 更改为 3。</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;manifest_version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-更新-permissions-和-host-permissions-字段" tabindex="-1">2. 更新 <code>permissions</code> 和 <code>host_permissions</code> 字段 <a class="header-anchor" href="#_2-更新-permissions-和-host-permissions-字段" aria-label="Permalink to &quot;2. 更新 \`permissions\` 和 \`host_permissions\` 字段&quot;">​</a></h3><p><code>Manifest V3</code> 中的主机权限是一个单独的字段；</p><p>不需要在 <code>permissions</code> 或 <code>optional_permissions</code> 中指定这些权限；</p><p>有单独的字段 <code>host_permissions</code> 来表示。</p><h4 id="_2-1-v2-版本" tabindex="-1">2.1. <code>V2</code> 版本 <a class="header-anchor" href="#_2-1-v2-版本" aria-label="Permalink to &quot;2.1. \`V2\` 版本&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;tabs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;bookmarks&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://www.blogger.com/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;optional_permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;unlimitedStorage&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;*://*/*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_2-2-v3-版本" tabindex="-1">2.2. <code>V3</code> 版本 <a class="header-anchor" href="#_2-2-v3-版本" aria-label="Permalink to &quot;2.2. \`V3\` 版本&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;tabs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;bookmarks&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;optional_permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;unlimitedStorage&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;host_permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://www.blogger.com/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;optional_host_permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;*://*/*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_3-更新-web-accessible-resources-字段" tabindex="-1">3. 更新 <code>web_accessible_resources</code> 字段 <a class="header-anchor" href="#_3-更新-web-accessible-resources-字段" aria-label="Permalink to &quot;3. 更新 \`web_accessible_resources\` 字段&quot;">​</a></h3><p><code>Manifest V3</code> 会限制哪些网站和插件可以访问插件中的资源，以此来限制数据公开范围；</p><p>在 <code>Manifest V2</code> 中，默认情况下，指定资源可供所有网站访问；</p><p>在下面的 <code>Manifest V3</code> 示例中，这些资源仅可供匹配的网站使用，而只有某些图片可供所有网站使用。</p><h4 id="_3-1-v2-版本" tabindex="-1">3.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-1-v2-版本" aria-label="Permalink to &quot;3.1. \`V2\` 版本&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;web_accessible_resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;images/*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;style/extension.css&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;script/extension.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_3-2-v3-版本" tabindex="-1">3.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-2-v3-版本" aria-label="Permalink to &quot;3.2. \`V3\` 版本&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;web_accessible_resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;images/*&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;matches&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;*://*/*&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;style/extension.css&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;script/extension.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;matches&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;https://example.com/*&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="_2、迁移到-service-worker" tabindex="-1">2、迁移到 <code>Service Worker</code> <a class="header-anchor" href="#_2、迁移到-service-worker" aria-label="Permalink to &quot;2、迁移到 \`Service Worker\`&quot;">​</a></h2><p>使用 <code>service worker</code> 替换 <code>background</code> 或 <code>event pages</code>，以确保后台代码远离主线程，这样可以让插件仅在需要时运行，从而节省资源。</p><h3 id="_1-background-和-service-worker-之间的区别" tabindex="-1">1. <code>Background</code> 和 <code>Service Worker</code> 之间的区别 <a class="header-anchor" href="#_1-background-和-service-worker-之间的区别" aria-label="Permalink to &quot;1. \`Background\` 和 \`Service Worker\` 之间的区别&quot;">​</a></h3><h4 id="_1-1-service-worker-和-background-之间的差异" tabindex="-1">1.1. <code>Service Worker</code> 和 <code>background</code> 之间的差异 <a class="header-anchor" href="#_1-1-service-worker-和-background-之间的差异" aria-label="Permalink to &quot;1.1. \`Service Worker\` 和 \`background\` 之间的差异&quot;">​</a></h4><ul><li>在主线程以外运行，这意味着不会干扰插件内容；</li><li>具有特殊功能，例如拦截插件来源上的提取事件，例如拦截工具栏弹出式窗口中的提取事件；</li><li>可以通过客户端界面与其他上下文进行通信和交互。</li></ul><h4 id="_1-2-改动点" tabindex="-1">1.2. 改动点 <a class="header-anchor" href="#_1-2-改动点" aria-label="Permalink to &quot;1.2. 改动点&quot;">​</a></h4><ul><li>由于它们无法访问 <code>DOM</code> 或 <code>window</code> 接口，因此需要将此类调用移至其他 <code>API</code> 或移至屏幕外文档中；</li><li>不应注册事件监听器来响应返回的 <code>promise</code> 或在事件回调内部；</li><li>不向后兼容 <code>XMLHttpRequest()</code>，因此需要将接口的调用替换为 <code>fetch()</code>；</li><li>由于它们在不使用时终止，因此需要保留应用状态，而不是依赖于全局变量；</li><li>终止 <code>Service Worker</code> 还可以在计时器完成之前结束计时器。需要将其替换为 <code>alarms</code>。</li></ul><h3 id="_2-更新-manifest-json-中的-background-字段" tabindex="-1">2. 更新 <code>manifest.json</code> 中的 <code>background</code> 字段 <a class="header-anchor" href="#_2-更新-manifest-json-中的-background-字段" aria-label="Permalink to &quot;2. 更新 \`manifest.json\` 中的 \`background\` 字段&quot;">​</a></h3><p>在 <code>Manifest V3</code> 中，background 页面被 <code>Service Worker</code> 所取代：</p><ul><li>将 <code>manifest.json</code> 中的 <code>&quot;background.scripts&quot;</code> 替换为 <code>&quot;background.service_worker&quot;</code>；</li><li><code>&quot;service_worker&quot;</code> 字段接受<strong>字符串</strong>，而不是字符串数组；</li><li>从 <code>manifest.json</code> 中移除 <code>&quot;background.persistent&quot;</code>。</li></ul><h4 id="_2-1-v2-版本-1" tabindex="-1">2.1. <code>V2</code> 版本 <a class="header-anchor" href="#_2-1-v2-版本-1" aria-label="Permalink to &quot;2.1. \`V2\` 版本&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;background&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;scripts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;backgroundContextMenus.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;backgroundOauth.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;persistent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_2-2-v3-版本-1" tabindex="-1">2.2. <code>V3</code> 版本 <a class="header-anchor" href="#_2-2-v3-版本-1" aria-label="Permalink to &quot;2.2. \`V3\` 版本&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>{</span></span>
<span class="line"><span>  &quot;background&quot;: {</span></span>
<span class="line"><span>    &quot;service_worker&quot;: &quot;service_worker.js&quot;,</span></span>
<span class="line"><span>    &quot;type&quot;: &quot;module&quot;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>&quot;service_worker&quot;</code> 字段接受单个字符串。只有使用 <code>ES module</code> （使用 <code>import</code> 关键字）时，才需要 <code>&quot;type&quot;</code> 字段。其值将始终为 <code>&quot;module&quot;</code>。</p><h3 id="_3-将-dom-和-window-调用移至屏幕外文档" tabindex="-1">3. 将 <code>DOM</code> 和 <code>window</code> 调用移至屏幕外文档 <a class="header-anchor" href="#_3-将-dom-和-window-调用移至屏幕外文档" aria-label="Permalink to &quot;3. 将 \`DOM\` 和 \`window\` 调用移至屏幕外文档&quot;">​</a></h3><p>某些插件需要访问 <code>DOM</code> 和 <code>window</code> 对象，无需打开新的窗口或标签页。<code>Offscreen API</code> 支持这类使用情形，因为这类 <code>API</code> 可以打开和关闭与插件打包在一起的未显示文档，而不会干扰用户体验。除了消息传递之外，屏幕外文档不会与其他插件上下文共享 <code>API</code>，而是起到完整网页的作用，供插件进行互动。</p><p>如需使用 <code>Offscreen API</code>，请通过 <code>Service Worker</code> 创建屏幕外文档。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.offscreen.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createDocument</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  url: chrome.runtime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;offscreen.html&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  reasons: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CLIPBOARD&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  justification: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;testing the offscreen API&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_4-将-localstorage-转换为其他类型" tabindex="-1">4. 将 <code>localStorage</code> 转换为其他类型 <a class="header-anchor" href="#_4-将-localstorage-转换为其他类型" aria-label="Permalink to &quot;4. 将 \`localStorage\` 转换为其他类型&quot;">​</a></h3><p><code>Web</code> 平台的 <code>Storage</code> 接口（可从 <code>window.localStorage</code> 访问）无法在 <code>Service Worker</code> 中使用。</p><p>请使用 <code>chrome.storage.local</code></p><h3 id="_5-同步注册监听器" tabindex="-1">5. 同步注册监听器 <a class="header-anchor" href="#_5-同步注册监听器" aria-label="Permalink to &quot;5. 同步注册监听器&quot;">​</a></h3><p>异步注册监听器（例如在 <code>promise</code> 或 <code>callback</code> 中）注册并不一定能在 <code>Manifest V3</code> 中有效。</p><h4 id="_5-1-v2-版本" tabindex="-1">5.1. <code>V2</code> 版本 <a class="header-anchor" href="#_5-1-v2-版本" aria-label="Permalink to &quot;5.1. \`V2\` 版本&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.storage.local.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;badgeText&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], ({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">badgeText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chrome.browserAction.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setBadgeText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ text: badgeText });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chrome.browserAction.onClicked.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handleActionClick);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在 <code>Manifest V3</code> 中，系统会在分派事件时重新初始化 <code>Service Worker</code>。这意味着当事件触发时，系统不会注册监听器（因为它们是异步添加的），系统还会错过事件。</p><h4 id="_5-2-v3-版本" tabindex="-1">5.2. <code>V3</code> 版本 <a class="header-anchor" href="#_5-2-v3-版本" aria-label="Permalink to &quot;5.2. \`V3\` 版本&quot;">​</a></h4><p>改为将事件监听器注册移至脚本的顶层。这样可以确保 <code>Chrome</code> 能够立即找到并调用操作的点击处理程序，即使插件尚未执行其启动逻辑也是如此。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.action.onClicked.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handleActionClick);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.storage.local.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;badgeText&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], ({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">badgeText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chrome.action.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setBadgeText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ text: badgeText });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_6-将-xmlhttprequest-替换为全局-fetch" tabindex="-1">6. 将 <code>XMLHttpRequest()</code> 替换为全局 <code>fetch()</code> <a class="header-anchor" href="#_6-将-xmlhttprequest-替换为全局-fetch" aria-label="Permalink to &quot;6. 将 \`XMLHttpRequest()\` 替换为全局 \`fetch()\`&quot;">​</a></h3><p>无法从 <code>Service Worker</code>、插件或其他方法调用 <code>XMLHttpRequest()</code>。将后台脚本对 <code>XMLHttpRequest()</code> 的调用替换为对 <code>fetch()</code> 的调用。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://www.example.com/greeting.json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(response.statusText);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_7-保存状态" tabindex="-1">7. 保存状态 <a class="header-anchor" href="#_7-保存状态" aria-label="Permalink to &quot;7. 保存状态&quot;">​</a></h3><p><code>Service Worker</code> 是临时的，这意味着它们可能会在用户的浏览器会话期间反复启动、运行和终止。这也意味着，自之前的上下文销毁后，数据并非立即在全局变量中可用。如需解决此问题，请使用存储 <code>API</code>。</p><p>对于 <code>Manifest V3</code> 来说，要将全局变量替换为对 <code>Storage API</code> 的调用。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.runtime.onMessage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;set-name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    chrome.storage.local.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ name });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.action.onClicked.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tab</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chrome.storage.local.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chrome.tabs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tab.id, { name });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_8-把计时器-定时器替换为-alarms" tabindex="-1">8. 把计时器/定时器替换为 <code>alarms</code> <a class="header-anchor" href="#_8-把计时器-定时器替换为-alarms" aria-label="Permalink to &quot;8. 把计时器/定时器替换为 \`alarms\`&quot;">​</a></h3><p><code>setTimeout()</code> 或 <code>setInterval()</code> 在 <code>Web</code> 开发中比较常见。不过，在 <code>Service Worker</code> 中可能会失败，因为每当 <code>Service Worker</code> 终止时，计时器就会取消。</p><h4 id="_8-1-v2-版本" tabindex="-1">8.1. <code>V2</code> 版本 <a class="header-anchor" href="#_8-1-v2-版本" aria-label="Permalink to &quot;8.1. \`V2\` 版本&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3 minutes in milliseconds</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TIMEOUT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chrome.action.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setIcon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    path: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRandomIconPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TIMEOUT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_8-2-v3-版本" tabindex="-1">8.2. <code>V3</code> 版本 <a class="header-anchor" href="#_8-2-v3-版本" aria-label="Permalink to &quot;8.2. \`V3\` 版本&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> startAlarm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chrome.alarms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, { delayInMinutes: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.alarms.onAlarm.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chrome.action.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setIcon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    path: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRandomIconPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_3、api-调用" tabindex="-1">3、<code>API</code> 调用 <a class="header-anchor" href="#_3、api-调用" aria-label="Permalink to &quot;3、\`API\` 调用&quot;">​</a></h2><h3 id="_1-将-tab-executescript-替换为-scripting-executescript" tabindex="-1">1. 将 <code>tab.executeScript()</code> 替换为 <code>scripting.executeScript()</code> <a class="header-anchor" href="#_1-将-tab-executescript-替换为-scripting-executescript" aria-label="Permalink to &quot;1. 将 \`tab.executeScript()\` 替换为 \`scripting.executeScript()\`&quot;">​</a></h3><p>在 <code>Manifest V3</code> 中，<code>executeScript()</code> 从 <code>tabs API</code> 移至 <code>scripting</code> <code>API</code>。这就需要在实际的代码更改的基础上更改 <code>manifest.json</code> 文件中的权限。</p><p>对于 <code>executeScript()</code> 方法：</p><ul><li><code>&quot;scripting&quot;</code> 权限；</li><li><code>host permissions</code> 权限或 <code>&quot;activeTab&quot;</code> 权限。</li></ul><p><code>scripting.executeScript()</code> 方法与其使用 <code>tabs.executeScript()</code> 的方式类似。但还是有一些区别。</p><ul><li>旧方法只能接受一个文件，而新方法可以接受一组文件；</li><li>还将传递 <code>ScriptInjection</code> 对象，而不是 <code>InjectDetails</code>。</li></ul><h4 id="_1-1-v2-版本" tabindex="-1">1.1. <code>V2</code> 版本 <a class="header-anchor" href="#_1-1-v2-版本" aria-label="Permalink to &quot;1.1. \`V2\` 版本&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCurrentTab</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* ... */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tab </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCurrentTab</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.tabs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeScript</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tab.id,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    file: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;content-script.js&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>代码在 <code>background</code> 脚本中</p></blockquote><h4 id="_1-2-v3-版本" tabindex="-1">1.2. <code>V3</code> 版本 <a class="header-anchor" href="#_1-2-v3-版本" aria-label="Permalink to &quot;1.2. \`V3\` 版本&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCurrentTab</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tab </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCurrentTab</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.scripting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeScript</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  target: {tabId: tab.id},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  files: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;content-script.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>代码在 service worker 中</p></blockquote><h3 id="_2-将-tab-insertcss-和-tab-removecss-替换为-scripting-insertcss-和-scripting-removecss" tabindex="-1">2. 将 <code>tab.insertCSS()</code> 和 <code>tab.removeCSS()</code> 替换为 <code>scripting.insertCSS()</code> 和 <code>scripting.removeCSS()</code> <a class="header-anchor" href="#_2-将-tab-insertcss-和-tab-removecss-替换为-scripting-insertcss-和-scripting-removecss" aria-label="Permalink to &quot;2. 将 \`tab.insertCSS()\` 和 \`tab.removeCSS()\` 替换为 \`scripting.insertCSS()\` 和 \`scripting.removeCSS()\`&quot;">​</a></h3><p>在 <code>Manifest V3</code> 中，<code>insertCSS()</code> 和 <code>removeCSS()</code> 已从 <code>tabs API</code> 移至 <code>scriptingAPI</code>。不仅需要更改代码，还需要对 <code>manifest.json</code> 文件中的权限进行更改：</p><ul><li><code>&quot;scripting&quot;</code> 权限；</li><li><code>host permissions</code> 权限或 <code>&quot;activeTab&quot;</code> 权限。</li></ul><p><code>scripting API</code> 上的函数与 <code>tabs</code> 上的函数类似。但还是有一些区别。</p><ul><li>调用这些方法时，需要传递 <code>CSSInjection</code> 对象，而不是 <code>InjectDetails</code>；</li><li><code>tabId</code> 作为 <code>CSSInjection.target</code> 的成员（而不是方法参数）进行传递。</li></ul><h4 id="_2-1-v2-版本-2" tabindex="-1">2.1. <code>V2</code> 版本 <a class="header-anchor" href="#_2-1-v2-版本-2" aria-label="Permalink to &quot;2.1. \`V2\` 版本&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.tabs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insertCSS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tabId, injectDetails, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // callback code</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>代码在 <code>background</code> 脚本中</p></blockquote><h4 id="_2-2-v3-版本-2" tabindex="-1">2.2. <code>V3</code> 版本 <a class="header-anchor" href="#_2-2-v3-版本-2" aria-label="Permalink to &quot;2.2. \`V3\` 版本&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> insertPromise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chrome.scripting.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insertCSS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  files: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;style.css&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  target: { tabId: tab.id }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Remaining code.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>代码在 <code>service worker</code> 中</p></blockquote><h3 id="_3-将-browser-actions-和-page-actions-替换为-actions" tabindex="-1">3. 将 <code>Browser Actions</code> 和 <code>Page Actions</code> 替换为 <code>Actions</code> <a class="header-anchor" href="#_3-将-browser-actions-和-page-actions-替换为-actions" aria-label="Permalink to &quot;3. 将 \`Browser Actions\` 和 \`Page Actions\` 替换为 \`Actions\`&quot;">​</a></h3><p>在 <code>Manifest V2</code> 中，<code>Browser Actions</code> 和 <code>Page Actions</code> 是两个单独的概念。虽然一开始他们扮演的角色不同，但随着时间的推移，它们之间的差异越来越小。在 <code>Manifest V3</code> 中，这些概念已整合到 <code>Action</code> <code>API</code> 中。这需要更改 <code>manifest.json</code> 和插件代码。</p><p><code>Manifest V3</code> 中的操作与浏览器操作最为相似；不过，<code>action API</code> 不像 <code>pageAction</code> 那样提供 <code>hide()</code> 和 <code>show()</code>。如果仍需要页面操作，可以使用声明性内容模拟这些操作，也可以使用标签页 <code>ID</code> 调用 <code>enable()</code> 或 <code>disable()</code>。</p><h4 id="_3-1-将-browser-action-和-page-action-替换为-action" tabindex="-1">3.1. 将 <code>&quot;browser_action&quot;</code> 和 <code>&quot;page_action&quot;</code> 替换为 <code>&quot;action&quot;</code> <a class="header-anchor" href="#_3-1-将-browser-action-和-page-action-替换为-action" aria-label="Permalink to &quot;3.1. 将 \`&quot;browser_action&quot;\` 和 \`&quot;page_action&quot;\` 替换为 \`&quot;action&quot;\`&quot;">​</a></h4><p>在 <code>manifest.json</code> 中，将 <code>&quot;browser_action&quot;</code> 和 <code>&quot;page_action&quot;</code> 字段替换为 <code>&quot;action&quot;</code> 字段</p><h5 id="_3-1-1-v2-版本" tabindex="-1">3.1.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-1-1-v2-版本" aria-label="Permalink to &quot;3.1.1. \`V2\` 版本&quot;">​</a></h5><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;page_action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;browser_action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;default_popup&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;popup.html&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="_3-1-2-v3-版本" tabindex="-1">3.1.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-1-2-v3-版本" aria-label="Permalink to &quot;3.1.2. \`V3\` 版本&quot;">​</a></h5><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;default_popup&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;popup.html&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_3-2-将-browseraction-api-和-pageaction-api-替换为-action-api" tabindex="-1">3.2. 将 <code>BrowserAction API</code> 和 <code>pageAction API</code> 替换为 <code>Action API</code> <a class="header-anchor" href="#_3-2-将-browseraction-api-和-pageaction-api-替换为-action-api" aria-label="Permalink to &quot;3.2. 将 \`BrowserAction API\` 和 \`pageAction API\` 替换为 \`Action API\`&quot;">​</a></h4><p>如果 <code>Manifest V2</code> 使用 <code>browserAction</code> 和 <code>pageAction API</code>，现在应使用 <code>action API</code>。</p><h5 id="_3-2-1-v2-版本" tabindex="-1">3.2.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-2-1-v2-版本" aria-label="Permalink to &quot;3.2.1. \`V2\` 版本&quot;">​</a></h5><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.browserAction.onClicked.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.pageAction.onClicked.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="_3-2-2-v3-版本" tabindex="-1">3.2.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-2-2-v3-版本" aria-label="Permalink to &quot;3.2.2. \`V3\` 版本&quot;">​</a></h5><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.action.onClicked.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tab</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_4-将-callback-替换为-promise" tabindex="-1">4. 将 <code>callback</code> 替换为 <code>promise</code> <a class="header-anchor" href="#_4-将-callback-替换为-promise" aria-label="Permalink to &quot;4. 将 \`callback\` 替换为 \`promise\`&quot;">​</a></h3><p>在 <code>Manifest V3</code> 中，许多插件 <code>API</code> 方法都会返回 <code>promise</code>。</p><p>为了实现向后兼容性，许多方法在添加 <code>promise</code> 支持后会继续支持回调。需要注意的是，不能在同一函数调用中同时使用这两者。如果传递回调，则函数不会返回 <code>promise</code>；如果希望返回 <code>promise</code>，则也不要传递回调。某些 <code>API</code> 功能（例如事件监听器）将继续需要回调。</p><p>如需从回调转换为 <code>promise</code>，请移除回调并处理返回的 <code>promise</code>。</p><h4 id="_4-1-callback" tabindex="-1">4.1. <code>Callback</code> <a class="header-anchor" href="#_4-1-callback" aria-label="Permalink to &quot;4.1. \`Callback\`&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.permissions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newPerms, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">granted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (granted) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;granted&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;not granted&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_4-2-promise" tabindex="-1">4.2. <code>Promise</code> <a class="header-anchor" href="#_4-2-promise" aria-label="Permalink to &quot;4.2. \`Promise\`&quot;">​</a></h4><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newPerms</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { permissions: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;topSites&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.permissions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newPerms)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">granted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (granted) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;granted&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;not granted&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_5-替换需要-manifest-v2-background-上下文的函数" tabindex="-1">5. 替换需要 <code>Manifest V2 background</code> 上下文的函数 <a class="header-anchor" href="#_5-替换需要-manifest-v2-background-上下文的函数" aria-label="Permalink to &quot;5. 替换需要 \`Manifest V2 background\` 上下文的函数&quot;">​</a></h3><p>其他插件上下文只能使用消息传递与插件 <code>Service Worker</code> 交互。因此，需要替换需要后台上下文的调用，具体而言：</p><ul><li><code>chrome.runtime.getBackgroundPage()</code></li><li><code>chrome.extension.getBackgroundPage()</code></li><li><code>chrome.extension.getExtensionTabs()</code></li></ul><p>插件脚本应使用消息传递在 <code>Service Worker</code> 和插件的其他部分之间进行通信。目前，这需要使用 <code>sendMessage()</code>，并在插件 <code>Service Worker</code> 中实现 <code>chrome.runtime.onMessage</code>。从长远来看，应计划将这些调用替换为 <code>postMessage()</code> 和 <code>Service Worker</code> 的消息事件处理程序。</p><h3 id="_6-替换不受支持的-api" tabindex="-1">6. 替换不受支持的 <code>API</code> <a class="header-anchor" href="#_6-替换不受支持的-api" aria-label="Permalink to &quot;6. 替换不受支持的 \`API\`&quot;">​</a></h3><p>需要在 <code>Manifest V3</code> 中更改下列方法和属性。</p><table><thead><tr><th><code>Manifest V2</code> 方法或属性</th><th>替换为 <code>Manifest V3</code> 方法或属性</th></tr></thead><tbody><tr><td><code>chrome.extension.connect()</code></td><td><code>chrome.runtime.connect() </code></td></tr><tr><td><code>chrome.extension.connectNative()</code></td><td><code>chrome.runtime.connectNative() </code></td></tr><tr><td><code>chrome.extension.getExtensionTabs()</code></td><td><code>chrome.extension.getViews() </code></td></tr><tr><td><code>chrome.extension.getURL() </code></td><td><code>chrome.runtime.getURL() </code></td></tr><tr><td><code>chrome.extension.lastError </code></td><td>如果方法返回 <code>promise</code>，请使用 <code>promise.catch() </code></td></tr><tr><td><code>chrome.extension.onConnect </code></td><td><code>chrome.runtime.onConnect </code></td></tr><tr><td><code>chrome.extension.onConnectExternal</code></td><td><code>chrome.runtime.onConnectExternal</code></td></tr><tr><td><code>chrome.extension.onMessage </code></td><td><code>chrome.runtime.onMessage</code></td></tr><tr><td><code>chrome.extension.onRequest</code></td><td><code>chrome.runtime.onRequest</code></td></tr><tr><td><code>chrome.extension.onRequestExternal </code></td><td><code>chrome.runtime.onMessageExternal</code></td></tr><tr><td><code>chrome.extension.sendMessage() </code></td><td><code>chrome.runtime.sendMessage()</code></td></tr><tr><td><code>chrome.extension.sendNativeMessage()</code></td><td><code>chrome.runtime.sendNativeMessage()</code></td></tr><tr><td><code>chrome.extension.sendRequest() </code></td><td><code>chrome.runtime.sendMessage() </code></td></tr><tr><td><code>chrome.runtime.onSuspend</code>（<code>background</code> 脚本）</td><td>在插件 <code>Service Worker</code> 中不受支持。请改用 <code>beforeunload</code> 文档事件。</td></tr><tr><td><code>chrome.tabs.getAllInWindow() </code></td><td><code>chrome.tabs.query() </code></td></tr><tr><td><code>chrome.tabs.getSelected()</code></td><td><code>chrome.tabs.query() </code></td></tr><tr><td><code>chrome.tabs.onActiveChanged</code></td><td><code>chrome.tabs.onActivated </code></td></tr><tr><td><code>chrome.tabs.onHighlightChanged </code></td><td><code>chrome.tabs.onHighlighted </code></td></tr><tr><td><code>chrome.tabs.onSelectionChanged </code></td><td><code>chrome.tabs.onActivated </code></td></tr><tr><td><code>chrome.tabs.sendRequest()</code></td><td><code>chrome.runtime.sendMessage() </code></td></tr><tr><td><code>chrome.tabs.Tab.selected</code></td><td><code>chrome.tabs.Tab.highlighted </code></td></tr></tbody></table><h2 id="_4、替换屏蔽-web-请求监听器" tabindex="-1">4、替换屏蔽 <code>Web</code> 请求监听器 <a class="header-anchor" href="#_4、替换屏蔽-web-请求监听器" aria-label="Permalink to &quot;4、替换屏蔽 \`Web\` 请求监听器&quot;">​</a></h2><p><code>Manifest V3</code> 更改了插件处理网络请求修改的方式。插件会指定规则来描述在满足一组给定条件时要执行的操作，而不是拦截网络请求并在运行时使用 <code>chrome.webRequest</code> 更改请求。</p><p><code>Web Request API</code> 和声明式网络请求 <code>API</code> 有很大的区别。需要根据用例重新编写代码，而不是将一个函数调用替换为另一个函数调用。</p><h3 id="_1-更新-permissions" tabindex="-1">1. 更新 <code>permissions</code> <a class="header-anchor" href="#_1-更新-permissions" aria-label="Permalink to &quot;1. 更新 \`permissions\`&quot;">​</a></h3><p>对 <code>manifest.json</code> 中的 <code>&quot;permissions&quot;</code> 字段进行以下更改。</p><ul><li>如果不再需要观察网络请求，请移除 <code>&quot;webRequest&quot;</code> 权限；</li><li>将匹配模式从 <code>&quot;permissions&quot;</code> 移至 <code>&quot;host_permissions&quot;</code>。</li></ul><p>需要根据使用场景添加其他权限。这些权限通过其支持的用例进行描述。</p><h3 id="_2-创建声明性网络请求规则" tabindex="-1">2. 创建声明性网络请求规则 <a class="header-anchor" href="#_2-创建声明性网络请求规则" aria-label="Permalink to &quot;2. 创建声明性网络请求规则&quot;">​</a></h3><p>如需创建声明性 <code>net</code> 请求规则，需要向 <code>manifest.json</code> 添加 <code>&quot;declarative_net_request&quot;</code> 对象。<code>&quot;declarative_net_request&quot;</code> 代码块包含指向规则文件的 <code>&quot;rule_resource&quot;</code> 对象数组。规则文件包含一组对象，用于指定操作以及调用这些操作的条件。</p><h3 id="_3-常见使用场景" tabindex="-1">3. 常见使用场景 <a class="header-anchor" href="#_3-常见使用场景" aria-label="Permalink to &quot;3. 常见使用场景&quot;">​</a></h3><h4 id="_3-1-屏蔽单个网址" tabindex="-1">3.1. 屏蔽单个网址 <a class="header-anchor" href="#_3-1-屏蔽单个网址" aria-label="Permalink to &quot;3.1. 屏蔽单个网址&quot;">​</a></h4><p><code>Manifest V2</code> 中的一个常见用例是在后台脚本中使用 <code>onBeforeRequest</code> 事件来屏蔽网络请求。</p><h5 id="_3-1-1-background-脚本改为-v3-规则文件" tabindex="-1">3.1.1. <code>Background</code> 脚本改为 <code>V3</code> 规则文件 <a class="header-anchor" href="#_3-1-1-background-脚本改为-v3-规则文件" aria-label="Permalink to &quot;3.1.1. \`Background\` 脚本改为 \`V3\` 规则文件&quot;">​</a></h5><h6 id="_3-1-1-1-规则文件" tabindex="-1">3.1.1.1. 规则文件 <a class="header-anchor" href="#_3-1-1-1-规则文件" aria-label="Permalink to &quot;3.1.1.1. 规则文件&quot;">​</a></h6><ol><li><code>rule.json</code></li></ol><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;priority&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;condition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;urlFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;||example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;resourceTypes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main_frame&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li>示例</li></ol><p><img src="`+e+`" alt="示例" loading="lazy"></p><ol start="3"><li><code>Manifest.json</code> 文件引入</li></ol><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;URL Blocker&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0.1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;manifest_version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;description&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Uses the chrome.declarativeNetRequest API to block requests.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;background&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;service_worker&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;service_worker.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;declarative_net_request&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;rule_resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ruleset_1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;enabled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;path&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rules_1.json&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;declarativeNetRequest&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;declarativeNetRequestFeedback&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h6 id="_3-1-1-2-v2-版本" tabindex="-1">3.1.1.2. <code>V2</code> 版本 <a class="header-anchor" href="#_3-1-1-2-v2-版本" aria-label="Permalink to &quot;3.1.1.2. \`V2\` 版本&quot;">​</a></h6><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.webRequest.onBeforeRequest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { cancel: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, { urls: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://www.example.com/*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] }, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blocking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h6 id="_3-1-1-3-v3-版本" tabindex="-1">3.1.1.3. <code>V3</code> 版本 <a class="header-anchor" href="#_3-1-1-3-v3-版本" aria-label="Permalink to &quot;3.1.1.3. \`V3\` 版本&quot;">​</a></h6><p>对于 <code>Manifest V3</code>，请使用 <code>&quot;block&quot;</code> 操作类型创建新的 <code>declarativeNetRequest</code> 规则。请注意示例规则中的 <code>&quot;condition&quot;</code> 对象。其 <code>&quot;urlFilter&quot;</code> 取代了传递给 <code>webRequest</code> 监听器的 <code>urls</code> 选项。<code>&quot;resourceTypes&quot;</code> 数组指定要屏蔽的资源的类别。</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;priority&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;condition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;urlFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;||example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;resourceTypes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main_frame&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="_3-1-2-需要更新该插件的权限。" tabindex="-1">3.1.2. 需要更新该插件的权限。 <a class="header-anchor" href="#_3-1-2-需要更新该插件的权限。" aria-label="Permalink to &quot;3.1.2. 需要更新该插件的权限。&quot;">​</a></h5><p>在 <code>manifest.json 中</code>，将 <code>&quot;webRequestBlocking&quot;</code> 权限替换为 <code>&quot;declarativeNetRequest&quot;</code> 权限。请注意，由于屏蔽内容不需要主机权限，因此该网址已从 <code>&quot;permissions&quot;</code> 字段中移除。</p><h6 id="_3-1-2-1-v2-版本" tabindex="-1">3.1.2.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-1-2-1-v2-版本" aria-label="Permalink to &quot;3.1.2.1. \`V2\` 版本&quot;">​</a></h6><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;webRequestBlocking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://*.example.com/*&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h6 id="_3-1-2-2-v3-版本" tabindex="-1">3.1.2.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-1-2-2-v3-版本" aria-label="Permalink to &quot;3.1.2.2. \`V3\` 版本&quot;">​</a></h6><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;declarativeNetRequest&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_3-2-重定向多个网址" tabindex="-1">3.2. 重定向多个网址 <a class="header-anchor" href="#_3-2-重定向多个网址" aria-label="Permalink to &quot;3.2. 重定向多个网址&quot;">​</a></h4><p><code>Manifest V2</code> 中的另一个常见用例是使用 <code>BeforeRequest</code> 事件重定向网络请求。</p><h5 id="_3-2-1-background-脚本改为-v3-规则文件" tabindex="-1">3.2.1. <code>Background</code> 脚本改为 <code>V3</code> 规则文件 <a class="header-anchor" href="#_3-2-1-background-脚本改为-v3-规则文件" aria-label="Permalink to &quot;3.2.1. \`Background\` 脚本改为 \`V3\` 规则文件&quot;">​</a></h5><h6 id="_3-2-1-1-v2-版本" tabindex="-1">3.2.1.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-2-1-1-v2-版本" aria-label="Permalink to &quot;3.2.1.1. \`V2\` 版本&quot;">​</a></h6><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.webRequest.onBeforeRequest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { redirectUrl: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://developer.chrome.com/docs/extensions/mv3/intro/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }, { </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    urls: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;https://developer.chrome.com/docs/extensions/mv2/&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blocking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h6 id="_3-2-1-2-v3-版本" tabindex="-1">3.2.1.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-2-1-2-v3-版本" aria-label="Permalink to &quot;3.2.1.2. \`V3\` 版本&quot;">​</a></h6><p>对于 <code>Manifest V3</code>，请使用 <code>&quot;redirect&quot;</code> 操作类型。与之前一样，<code>&quot;urlFilter&quot;</code> 会替换传递给 <code>webRequest</code> 监听器的 <code>url</code> 选项。请注意，在此示例中，规则文件的 <code>&quot;action&quot;</code> 对象包含一个 <code>&quot;redirect&quot;</code> 字段，其中包含要返回的网址，而不是要过滤的网址。</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;priority&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;redirect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;redirect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://developer.chrome.com/docs/extensions/mv3/intro/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;condition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;urlFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://developer.chrome.com/docs/extensions/mv2/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;resourceTypes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main_frame&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="_3-2-2-需要更改插件的权限" tabindex="-1">3.2.2. 需要更改插件的权限 <a class="header-anchor" href="#_3-2-2-需要更改插件的权限" aria-label="Permalink to &quot;3.2.2. 需要更改插件的权限&quot;">​</a></h5><p>将 <code>&quot;webRequestBlocking&quot;</code> 权限替换为 <code>&quot;declarativeNetRequest&quot;</code> 权限。系统再次将这些网址从 <code>manifest.json</code> 移到了规则文件中。请注意，除了主机权限之外，重定向还需要 <code>&quot;declarativeNetRequestWithHostAccess&quot;</code> 权限。</p><h6 id="_3-2-2-1-v2-版本" tabindex="-1">3.2.2.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-2-2-1-v2-版本" aria-label="Permalink to &quot;3.2.2.1. \`V2\` 版本&quot;">​</a></h6><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;webRequestBlocking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://developer.chrome.com/docs/extensions/*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://developer.chrome.com/docs/extensions/reference&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h6 id="_3-2-2-2-v3-版本" tabindex="-1">3.2.2.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-2-2-2-v3-版本" aria-label="Permalink to &quot;3.2.2.2. \`V3\` 版本&quot;">​</a></h6><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;declarativeNetRequestWithHostAccess&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;host_permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://developer.chrome.com/*&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_3-3-屏蔽-cookie" tabindex="-1">3.3. 屏蔽 <code>Cookie</code> <a class="header-anchor" href="#_3-3-屏蔽-cookie" aria-label="Permalink to &quot;3.3. 屏蔽 \`Cookie\`&quot;">​</a></h4><p>在 <code>Manifest V2</code> 中，要屏蔽 <code>Cookie</code>，需要先拦截网络请求标头，然后再发送这些标头并移除特定的 <code>Cookie</code>。</p><h5 id="_3-3-1-background-脚本改为-v3-规则文件" tabindex="-1">3.3.1. <code>Background</code> 脚本改为 <code>V3</code> 规则文件 <a class="header-anchor" href="#_3-3-1-background-脚本改为-v3-规则文件" aria-label="Permalink to &quot;3.3.1. \`Background\` 脚本改为 \`V3\` 规则文件&quot;">​</a></h5><h6 id="_3-3-1-1-v2-版本" tabindex="-1">3.3.1.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-3-1-1-v2-版本" aria-label="Permalink to &quot;3.3.1.1. \`V2\` 版本&quot;">​</a></h6><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome.webRequest.onBeforeSendHeaders.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">details</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    removeHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(details.requestHeaders, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cookie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {requestHeaders: details.requestHeaders};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // filters</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {urls: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://*/*&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;http://*/*&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]},</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // extraInfoSpec</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;blocking&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;requestHeaders&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;extraHeaders&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h6 id="_3-3-1-2-v3-版本" tabindex="-1">3.3.1.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-3-1-2-v3-版本" aria-label="Permalink to &quot;3.3.1.2. \`V3\` 版本&quot;">​</a></h6><p><code>Manifest V3</code> 也通过规则文件中的规则实现这一点。这次的操作类型为 <code>&quot;modifyHeaders&quot;</code>。该文件接受 <code>&quot;requestHeaders&quot;</code> 对象数组，用于指定要修改的标头以及如何修改这些标头。请注意，<code>&quot;condition&quot;</code> 对象仅包含 <code>&quot;resourceTypes&quot;</code> 数组。它支持的值与前面的示例相同。</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;priority&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;modifyHeaders&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;requestHeaders&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;header&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cookie&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;operation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;remove&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;condition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;urlFilter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;|*?no-cookies=1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;resourceTypes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main_frame&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="_3-3-2-需要更新该插件的权限。" tabindex="-1">3.3.2. 需要更新该插件的权限。 <a class="header-anchor" href="#_3-3-2-需要更新该插件的权限。" aria-label="Permalink to &quot;3.3.2. 需要更新该插件的权限。&quot;">​</a></h5><p>将 <code>&quot;webRequestBlocking&quot;</code> 权限替换为 <code>&quot;declarativeNetRequest&quot;</code> 权限。</p><h6 id="_3-3-2-1-v2-版本" tabindex="-1">3.3.2.1. <code>V2</code> 版本 <a class="header-anchor" href="#_3-3-2-1-v2-版本" aria-label="Permalink to &quot;3.3.2.1. \`V2\` 版本&quot;">​</a></h6><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;webRequestBlocking&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://developer.chrome.com/docs/extensions/*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://developer.chrome.com/docs/extensions/reference&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h6 id="_3-3-2-2-v3-版本" tabindex="-1">3.3.2.2. <code>V3</code> 版本 <a class="header-anchor" href="#_3-3-2-2-v3-版本" aria-label="Permalink to &quot;3.3.2.2. \`V3\` 版本&quot;">​</a></h6><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;declarativeNetRequestWithHostAccess&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;host_permissions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;https://developer.chrome.com/*&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div>`,194),p=[t];function h(r,o,k,d,c,E){return i(),a("div",null,p)}const g=s(l,[["render",h]]);export{b as __pageData,g as default};
